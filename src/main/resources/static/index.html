<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Test Data Generator</title>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #f5f6fa; margin:0; padding:2rem; display:flex; flex-direction:column; align-items:center; }
        .container { background:white; padding:2rem; border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.1); width:600px; max-width:90%; }
        h1 { text-align:center; margin-bottom:1rem; }
        input, textarea, button { width:100%; margin:0.5rem 0; padding:0.75rem; font-size:1rem; border-radius:0.5rem; border:1px solid #ccc; }
        button { background-color:#4CAF50; color:white; border:none; cursor:pointer; }
        button:hover { background-color:#45a049; }
        pre { background-color:#f0f0f0; padding:1rem; border-radius:0.5rem; max-height:300px; overflow-y:auto; }
        .optional-label { font-size:0.9rem; color:#555; }
    </style>
</head>
<body>
<div class="container">
    <h1>AI Test Data Generator</h1>

    <!-- License Section -->
    <div id="licenseSection">
        <label for="licenseKey">Enter your Pro license key:</label>
        <input id="licenseKey" type="text" placeholder="lsq_12345abcdef" />
        <button id="verifyLicense">Verify</button>
    </div>

    <!-- Generator Section -->
    <div id="generatorSection">
        <label>Fields (comma-separated):</label>
        <input type="text" id="fields" value="firstName,lastName,email,city,jobTitle" />

        <label>Number of rows:</label>
        <input type="number" id="rows" value="3" min="1" max="100" />

        <label class="optional-label">Advanced instructions (optional, plain English):</label>
        <textarea id="advancedInstructions" placeholder="E.g., '50% of users live in the same city'"></textarea>

        <button id="generateBtn">Generate</button>

        <h3>Result:</h3>
        <pre id="result">Click "Generate" to see data...</pre>
    </div>
</div>

<script>
    // Check if user is Pro from localStorage
    let isPro = localStorage.getItem("isPro") === "true";

    function unlockProFeatures() {
        isPro = true;
        localStorage.setItem("isPro", "true");
        document.getElementById("licenseSection").style.display = "none";
        alert("‚úÖ Pro features unlocked! You now have unlimited rows and CSV export.");
    }

    // Auto-check license from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const licenseFromUrl = urlParams.get("license");
    if (licenseFromUrl) {
        document.getElementById("licenseKey").value = licenseFromUrl;
        verifyLicense(licenseFromUrl);
    }

    document.getElementById("verifyLicense").onclick = () => {
        const key = document.getElementById("licenseKey").value.trim();
        if (key) verifyLicense(key);
    };

    function verifyLicense(key) {
        fetch("/api/license/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ licenseKey: key })
        })
        .then(res => res.json())
        .then(data => {
            if (data.valid || (data.license && data.license.status === "active")) {
                unlockProFeatures();
            } else {
                alert("‚ùå Invalid or expired license key.");
            }
        })
        .catch(err => {
            console.error(err);
            alert("‚ùå Error verifying license. Try again later.");
        });
    }

    // Generate Data Button
    document.getElementById("generateBtn").addEventListener("click", async () => {
        let fields = document.getElementById("fields").value.split(",").map(f => f.trim()).filter(f => f);
        let rows = parseInt(document.getElementById("rows").value, 10);
        const advancedInstructions = document.getElementById("advancedInstructions").value.trim();

        if (!isPro && rows > 50) {
            alert("Free users can only generate up to 50 rows. Upgrade to Pro for unlimited rows.");
            rows = 50;
        }

        const payload = { fields, rows };
        if (advancedInstructions.length > 0) payload.advancedInstructions = advancedInstructions;

        const resultEl = document.getElementById("result");
        resultEl.textContent = "Generating data... ‚è≥";

        try {
            const response = await fetch("/api/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            resultEl.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
            resultEl.textContent = "‚ùå Error: " + err.message;
        }
    });

    // Optional: show thank you alert if ?upgraded=true
    if (urlParams.get("upgraded") === "true") {
        alert("üéâ Thank you for upgrading to Pro! You now have access to higher limits and CSV export.");
    }

    // Hide license section if already Pro
    if (isPro) document.getElementById("licenseSection").style.display = "none";
</script>
</body>
</html>
